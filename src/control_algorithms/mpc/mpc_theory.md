# MPC理论与实现

## 1. MPC概述

模型预测控制（Model Predictive Control，MPC）是一种基于模型的先进控制方法，其核心思想是通过预测系统未来行为并优化控制序列来实现最优控制。

### 1.1 基本原理

MPC的基本原理包括以下几个步骤：
1. **系统建模**：建立系统的数学模型
2. **预测未来行为**：基于当前状态预测系统未来Np步的输出
3. **优化控制序列**：求解一个有限时域的优化问题，得到最优控制序列
4. **滚动优化**：只执行第一个控制输入，然后在下一个采样时刻重复上述过程

## 2. 数学模型

### 2.1 状态空间模型

考虑离散时间线性系统：
```
x(k+1) = A x(k) + B u(k)
y(k) = C x(k) + D u(k)
```

其中：
- `x(k)` 是k时刻的状态向量
- `u(k)` 是k时刻的控制输入
- `y(k)` 是k时刻的输出
- `A, B, C, D` 是系统矩阵

### 2.2 预测模型

基于状态空间模型，可以预测未来Np步的输出：
```
x(k+i+1) = A x(k+i) + B u(k+i)
y(k+i) = C x(k+i) + D u(k+i)
```

对于i = 0, 1, ..., Np-1

## 3. MPC优化问题

### 3.1 目标函数

MPC的目标是最小化期望输出与预测输出之间的误差，同时考虑控制输入的变化：

```
J = Σ_{i=1}^{Np} (y_d(k+i) - y(k+i))^T Q (y_d(k+i) - y(k+i)) + Σ_{i=0}^{Nc-1} Δu(k+i)^T R Δu(k+i)
```

其中：
- `Np` 是预测时域（10）
- `Nc` 是控制时域（5）
- `Q` 是输出误差权重矩阵
- `R` 是控制输入变化权重矩阵
- `Δu(k+i) = u(k+i) - u(k+i-1)` 是控制输入变化量

### 3.2 约束条件

MPC可以处理各种约束条件：

```
u_min ≤ u(k+i) ≤ u_max,  i = 0, 1, ..., Nc-1
y_min ≤ y(k+i) ≤ y_max,  i = 1, ..., Np
```

## 4. 实现细节

### 4.1 预测模型构建

将预测输出表示为控制输入序列和初始状态的线性组合：

```
y_pred = Φ u + Γ x_0
```

其中：
- `y_pred` 是预测输出向量（Np×1）
- `u` 是控制输入序列（Nc×1）
- `x_0` 是初始状态
- `Φ` 和 `Γ` 是预测矩阵

### 4.2 优化问题求解

将MPC问题转化为二次规划问题：

```
min_u J = (y_d - Φ u - Γ x_0)^T Q (y_d - Φ u - Γ x_0) + u^T R u
subject to: u_min ≤ u ≤ u_max
```

### 4.3 滚动优化

只执行第一个控制输入 `u(0)`，然后在下一个采样时刻重复整个过程。

## 5. 代码实现

### 5.1 核心函数

```matlab
function u = mpc_controller(y, yd, A, B, C, D, Np, Nc, Q, R, u_min, u_max)
    % 系统维度
    n = size(A, 1);  % 状态维度
    m = size(B, 2);  % 输入维度
    p = size(C, 1);  % 输出维度
    
    % 初始状态
    x = [y; zeros(n-p, 1)];
    
    % 构建预测模型
    Phi = zeros(Np*p, Nc*m);
    Gamma = zeros(Np*p, n);
    
    % 预测模型计算
    % ...（具体实现见mpc_controller.m）
    
    % 优化求解
    u = (Phi'*Q*Phi + R) \ (Phi'*Q*(yd - Gamma*x));
    
    % 只取第一个控制输入
    u = u(1:m);
    
    % 应用约束
    u = max(u, u_min);
    u = min(u, u_max);
end
```

### 5.2 关键参数

| 参数 | 取值 | 说明 |
| :--- | :--- | :--- |
| Np | 10 | 预测时域，预测未来10步输出 |
| Nc | 5 | 控制时域，优化未来5步控制输入 |
| Q | 单位矩阵 | 输出误差权重，强调跟踪精度 |
| R | 0.1×单位矩阵 | 控制输入权重，强调控制平滑性 |
| u_min | -2.0 | 控制输入下限 |
| u_max | 2.0 | 控制输入上限 |

## 6. 性能评估

### 6.1 评估指标

- **超调量**：输出超过期望值的最大百分比
- **调节时间**：输出进入并保持在期望值±5%范围内的时间
- **上升时间**：输出从10%上升到90%期望值的时间
- **均方根误差（RMSE）**：输出误差的均方根

### 6.2 影响因素

MPC性能受以下因素影响：
- 预测模型的准确性
- 预测时域Np和控制时域Nc的选择
- 权重矩阵Q和R的选择
- 约束条件的设置

## 7. 应用场景

MPC广泛应用于以下领域：

1. **过程控制**：化工、石油、电力等工业过程
2. **运动控制**：机器人、飞行器、自动驾驶车辆
3. **能源系统**：电力系统、可再生能源管理
4. **交通系统**：交通信号控制、智能交通管理
5. **机器人学**：机械臂控制、移动机器人导航

## 8. 扩展与改进

### 8.1 鲁棒MPC

考虑模型不确定性，提高系统鲁棒性。

### 8.2 非线性MPC

处理非线性系统，使用非线性预测模型。

### 8.3 分布式MPC

适用于大规模系统，将系统分解为多个子系统，每个子系统使用本地MPC控制器。

### 8.4 快速MPC

优化求解算法，提高实时性，适用于高速系统。

## 9. 结论

MPC是一种强大的控制方法，具有以下优点：
- 能够处理约束条件
- 适合多变量系统
- 可以实现最优控制
- 具有预测能力，能够提前调整控制输入

通过合理选择MPC参数，可以获得良好的控制性能，满足各种复杂系统的控制需求。
